import { useEffect, useState, useRef } from 'react';
import { Layout, Button, Space, message, Modal, Form, Input, Select, Steps } from 'antd';
import Card from 'antd/es/card';
import {
  SaveOutlined,
  ImportOutlined,
  ExportOutlined,
  UndoOutlined,
  RedoOutlined,
  ZoomInOutlined,
  ZoomOutOutlined,
  OneToOneOutlined,
  PlayCircleOutlined,
} from '@ant-design/icons';
import LogicFlow from '@logicflow/core';
import { DndPanel, SelectionSelect, Control, MiniMap } from '@logicflow/extension';
import '@logicflow/core/dist/index.css';
import '@logicflow/extension/lib/style/index.css';
import './index.css';

const { Sider, Content } = Layout;
const { Option } = Select;

// ËäÇÁÇπÁ±ªÂûãÂÆö‰πâ
const nodeTypes = [
  { type: 'circle', label: 'ÂºÄÂßãËäÇÁÇπ', icon: '‚≠ï' },
  { type: 'approval', label: 'ÂÆ°ÊâπËäÇÁÇπ', icon: 'üìù' },
  { type: 'condition', label: 'Êù°‰ª∂ËäÇÁÇπ', icon: '‚ùì' },
  { type: 'parallel', label: 'Âπ∂Ë°åËäÇÁÇπ', icon: '‚ö°' },
  { type: 'end', label: 'ÁªìÊùüËäÇÁÇπ', icon: 'üîö' },
];

interface ProcessDesignerProps {
  processKey?: string;
  onSave?: (data: any) => void;
}

interface GraphNode {
  id: string;
  type: string;
  properties?: {
    name?: string;
    [key: string]: any;
  };
}

interface GraphEdge {
  id: string;
  sourceNodeId: string;
  targetNodeId: string;
  type: string;
  properties?: Record<string, any>;
}

interface GraphData {
  nodes: GraphNode[];
  edges: GraphEdge[];
}

const ProcessDesigner: React.FC<ProcessDesignerProps> = ({ processKey, onSave }) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const [lf, setLf] = useState<LogicFlow>();
  const [nodeModalVisible, setNodeModalVisible] = useState(false);
  const [currentNode, setCurrentNode] = useState<any>(null);
  const [nodeForm] = Form.useForm();
  const [simulationVisible, setSimulationVisible] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [simulationPath, setSimulationPath] = useState<any[]>([]);

  // ÂàùÂßãÂåñÊµÅÁ®ãËÆæËÆ°Âô®
  useEffect(() => {
    if (!containerRef.current) return;

    const logicflow = new LogicFlow({
      container: containerRef.current,
      grid: true,
      plugins: [DndPanel, SelectionSelect, Control, MiniMap],
      nodeTextEdit: true,
      nodeTextDraggable: false,
      adjustEdge: true,
      adjustNodePosition: true,
      dragOnConnecting: true,
      style: {
        rect: {
          width: 120,
          height: 60,
          radius: 5,
          strokeWidth: 2,
        },
        circle: {
          r: 25,
          strokeWidth: 2,
        },
        diamond: {
          width: 80,
          height: 80,
          strokeWidth: 2,
        },
        nodeText: {
          overflowMode: 'autoWrap',
          fontSize: 12,
        },
        edgeText: {
          textWidth: 100,
          fontSize: 12,
          background: {
            fill: '#fff',
          },
        },
      },
    });

    console.log('LogicFlow Â∑≤ÂàùÂßãÂåñ');

    // ËÆæÁΩÆÈªòËÆ§ËæπÁ±ªÂûã
    logicflow.setDefaultEdgeType('polyline');

    // Ê≥®ÂÜåËäÇÁÇπ‰∫ã‰ª∂
    logicflow.on('node:click', ({ data }) => {
      setCurrentNode(data);
      nodeForm.setFieldsValue(data.properties);
      setNodeModalVisible(true);
    });

    // Ê≥®ÂÜåËæπ‰∫ã‰ª∂
    logicflow.on('edge:click', ({ data }) => {
      console.log('ÁÇπÂáªËæπ', data);
    });

    // Ê≥®ÂÜåÁîªÂ∏É‰∫ã‰ª∂
    logicflow.on('blank:click', () => {
      setCurrentNode(null);
      setNodeModalVisible(false);
    });

    // Ê≥®ÂÜåËøûÊé•‰∫ã‰ª∂
    logicflow.on('connection:created', ({ data }) => {
      console.log('ÂàõÂª∫ËøûÊé•', data);
    });

    // Ê≥®ÂÜåÂà†Èô§‰∫ã‰ª∂
    logicflow.on('element:delete', ({ data }) => {
      console.log('Âà†Èô§ÂÖÉÁ¥†', data);
    });

    const dndPanel = logicflow.extension.dndPanel as any;
    dndPanel.setPatternItems([
      {
        label: 'ÈÄâÂå∫',
        icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAAH6ji2bAAAABGdBTUEAALGPC/xhBQAAAOVJREFUOBGtVMENwzAIjKP++2026ETdpv10iy7WFbqFyyW6GBywLCv5gI+Dw2Bluj1znuSjhb99Gkn6QILDY2imo60p8nsnc9bEo3+QJ+AKHfMdZHnl78wyTnyHZD53Zzx73MRSgYvnqgCUHj6gwdck7Zsp1VOrz0Uz8NbKunzAW+Gu4fYW28bUYutYlzSa7B84Fh7d1kjLwhcSdYAYrdkMQVpsBr5XgDGuXwQfQr0y9zwLda+DUYXLaGKdd2ZTtvbolaO87pdo24hP7ov16N0zArH1ur3iwJpXxm+v7oAJNR4JEP8DoAuSFEkYH7cAAAAASUVORK5CYII=',
        callback: () => {
          const selectionSelect = logicflow.extension.selectionSelect as any;
          selectionSelect.openSelectionSelect();
          logicflow.once('selection:selected', () => {
            selectionSelect.closeSelectionSelect();
          });
        }
      },
      {
        type: 'circle',
        text: 'ÂºÄÂßã',
        label: 'ÂºÄÂßãËäÇÁÇπ',
        icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAAH6ji2bAAAABGdBTUEAALGPC/xhBQAAAnBJREFUOBGdVL1rU1EcPfdGBddmaZLiEhdx1MHZQXApraCzQ7GKLgoRBxMfcRELuihWKcXFRcEWF8HBf0DdDCKYRZpnl7p0svLe9Zzbd29eQhTbC8nv+9zf130AT63jvooOGS8Vf9Nt5zxba7sXQwODfkWpkbjTQfCGUd9gIp3uuPP8bZ946g56dYQvnBg+b1HB8VIQmMFrazKcKSvFW2dQTxJnJdQ77urmXWOMBCmXM2Rke4S7UAW+/8ywwFoewmBps2tu7mbTdp8VMOkIRAkKfrVawalJTtIliclFbaOBqa0M2xImHeVIfd/nKAfVq/LGnPss5Kh00VEdSzfwnBXPUpmykNss4lUI9C1ga+8PNrBD5YeqRY2Zz8PhjooIbfJXjowvQJBqkmEkVnktWhwu2SM7SMx7Cj0N9IC0oQXRo8xwAGzQms+xrB/nNSUWVveI48ayrFGyC2+E2C+aWrZHXvOuz+CiV6iycWe1Rd1Q6+QUG07nb5SbPrL4426d+9E1axKjY3AoRrlEeSQo2Eu0T6BWAAr6COhTcWjRaYfKG5csnvytvUr/WY4rrPMB53Uo7jZRjXaG6/CFfNMaXEu75nG47X+oepU7PKJvvzGDY1YLSKHJrK7vFUwXKkaxwhCW3u+sDFMVrIju54RYYbFKpALZAo7sB6wcKyyrd+aBMryMT2gPyD6GsQoRFkGHr14TthZni9ck0z+Pnmee460mHXbRAypKNy3nuMdrWgVKj8YVV8E7PSzp1BZ9SJnJAsXdryw/h5ctboUVi4AFiCd+lQaYMw5z3LGTBKjLQOeUF35k89f58Vv/tGh+l+PE/wG0rgfIUbZK5AAAAABJRU5ErkJggg==',
      },
      {
        type: 'rect',
        label: 'Áî®Êà∑‰ªªÂä°',
        icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAYAAAEFVwZaAAAABGdBTUEAALGPC/xhBQAAAqlJREFUOBF9VM9rE0EUfrMJNUKLihGbpLGtaCOIR8VjQMGDePCgCCIiCNqzCAp2MyYUCXhUtF5E0D+g1t48qAd7CCLqQUQKEWkStcEfVGlLdp/fm3aW2QQdyLzf33zz5m2IsAZ9XhDpyaaIZkTS4ASzK41TFao88GuJ3hsr2pAbipHxuSYyKRugagICGANkfFnNh3HeE2N0b3nN2cgnpcictw5veJIzxmDamSlxxQZicq/mflxhbaH8BLRbuRwNtZp0JAhoplVRUdzmCe/vO27wFuuA3S5qXruGdboy5/PRGFsbFGKo/haRtQHIrM83bVeTrOgNhZReWaYGnE4aUQgTJNvijJFF4jQ8BxJE5xfKatZWmZcTQ+BVgh7s8SgPlCkcec4mGTmieTP4xd7PcpIEg1TX6gdeLW8rTVMVLVvb7ctXoH0Cydl2QOPJBG21STE5OsnbweVYzAnD3A7PVILuY0yiiyDwSm2g441r6rMSgp6iK42yqroI2QoXeJVeA+YeZSa47gZdXaZWQKTrG93rukk/l2Al6Kzh5AZEl7dDQy+JjgFahQjRopSxPbrbvK7GRe9ePWBo1wcU7sYrFZtavXALwGw/7Dnc50urrHJuTPSoO2IMV3gUQGNg87IbSOIY9BpiT9HV7FCZ94nPXb3MSnwHn/FFFE1vG6DTby+r31KAkUktB3Qf6ikUPWxW1BkXSPQeMHHiW0+HAd2GelJsZz1OJegCxqzl+CLVHa/IibuHeJ1HAKzhuDR+ymNaRFM+4jU6UWKXorRmbyqkq/D76FffevwdCp+jN3UAN/C9JRVTDuOxC/oh+EdMnqIOrlYteKSfadVRGLJFJPSB/ti/6K8f0CNymg/iH2gO/f0DwE0yjAFO6l8JaR5j0VPwPwfaYHqOqrCI319WzwhwzNW/aQAAAABJRU5ErkJggg==',
        className: 'important-node'
      },
      {
        type: 'rect',
        label: 'Á≥ªÁªü‰ªªÂä°',
        icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAYAAAEFVwZaAAAABGdBTUEAALGPC/xhBQAAAqlJREFUOBF9VM9rE0EUfrMJNUKLihGbpLGtaCOIR8VjQMGDePCgCCIiCNqzCAp2MyYUCXhUtF5E0D+g1t48qAd7CCLqQUQKEWkStcEfVGlLdp/fm3aW2QQdyLzf33zz5m2IsAZ9XhDpyaaIZkTS4ASzK41TFao88GuJ3hsr2pAbipHxuSYyKRugagICGANkfFnNh3HeE2N0b3nN2cgnpcictw5veJIzxmDamSlxxQZicq/mflxhbaH8BLRbuRwNtZp0JAhoplVRUdzmCe/vO27wFuuA3S5qXruGdboy5/PRGFsbFGKo/haRtQHIrM83bVeTrOgNhZReWaYGnE4aUQgTJNvijJFF4jQ8BxJE5xfKatZWmZcTQ+BVgh7s8SgPlCkcec4mGTmieTP4xd7PcpIEg1TX6gdeLW8rTVMVLVvb7ctXoH0Cydl2QOPJBG21STE5OsnbweVYzAnD3A7PVILuY0yiiyDwSm2g441r6rMSgp6iK42yqroI2QoXeJVeA+YeZSa47gZdXaZWQKTrG93rukk/l2Al6Kzh5AZEl7dDQy+JjgFahQjRopSxPbrbvK7GRe9ePWBo1wcU7sYrFZtavXALwGw/7Dnc50urrHJuTPSoO2IMV3gUQGNg87IbSOIY9BpiT9HV7FCZ94nPXb3MSnwHn/FFFE1vG6DTby+r31KAkUktB3Qf6ikUPWxW1BkXSPQeMHHiW0+HAd2GelJsZz1OJegCxqzl+CLVHa/IibuHeJ1HAKzhuDR+ymNaRFM+4jU6UWKXorRmbyqkq/D76FffevwdCp+jN3UAN/C9JRVTDuOxC/oh+EdMnqIOrlYteKSfadVRGLJFJPSB/ti/6K8f0CNymg/iH2gO/f0DwE0yjAFO6l8JaR5j0VPwPwfaYHqOqrCI319WzwhwzNW/aQAAAABJRU5ErkJggg==',
        className: 'import_icon'
      },
      {
        type: 'diamond',
        label: 'Êù°‰ª∂Âà§Êñ≠',
        icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVCAYAAAHeEJUAAAAABGdBTUEAALGPC/xhBQAAAvVJREFUOBGNVEFrE0EU/mY3bQoiFlOkaUJrQUQoWMGePLX24EH0IIoHKQiCV0G8iE1covgLiqA/QTzVm1JPogc9tIJYFaQtlhQxqYjSpunu+L7JvmUTU3AgmTfvffPNN++9WSA1DO182f6xwILzD5btfAoQmwL5KJEwiQyVbSVZ0IgRyV6PTpIJ81E5ZvqfHQR0HUOBHW4L5Et2kQ6Zf7iAOhTFAA8s0pEP7AXO1uAA52SbqGk6h/6J45LaLhO64ByfcUzM39V7ZiAdS2yCePPEIQYvTUHqM/n7dgQNfBKWPjpF4ISk8q3J4nB11qw6X8l+FsF3EhlkEMfrjIer3wJTLwS2aCNcj4DbGxXTw00JmAuO+Ni6bBxVUCvS5d9aa04+so4pHW5jLTywuXAL7jJ+D06sl82Sgl2JuVBQn498zkc2bGKxULHjCnSMadBKYDYYHAtsby1EQ5lNGrQd4Y3v4Zo0XdGEmDno46yCM9Tk+RiJmUYHS/aXHPNTcjxcbTFna000PFJHIVZ5lFRqRpJWk9/+QtlOUYJj9HG5pVFEU7zqIYDVsw2s+AJaD8wTd2umgSCCyUxgGsS1Y6TBwXQQTFuZaHcd8gAGioE90hlsY+wMcs30RduYtxanjMGal8H5dMW67dmT1JFtYUEe8LiQLRsPZ6IIc7A4J5tqco3T0pnv/4u0kyzrYUq7gASuEyI8VXKvB9Odytv6jS/PNaZBln0nioJG/AVQRZvApOdhjj3Jt8QC8Im09SafwdBdvIpztpxWxpeKCC+EsFdS8DCyuCn2munFpL7ctHKp+Xc5cMybeIyMAN33SPL3ZR9QV1XVwLyzHm6Iv0/yeUuUb7PPlZC4D4HZkeu6dpF4v9j9MreGtMbxMMRLIcjJic9yHi7WQ3yVKzZVWUr5UrViJvn1FfUlwe/KYVfYyWRLSGNu16hR01U9IacajXPei0wx/5BqgInvJN+MMNtNme7ReU9SBbgntovn0kKHpFg7UogZvaZiOue/q1SBo9ktHzQAAAAASUVORK5CYII=',
      },
      {
        type: 'circle',
        text: 'ÁªìÊùü',
        label: 'ÁªìÊùüËäÇÁÇπ',
        icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAAH6ji2bAAAABGdBTUEAALGPC/xhBQAAA1BJREFUOBFtVE1IVUEYPXOf+tq40Y3vPcmFIdSjIorWoRG0ERWUgnb5FwVhYQSl72oUoZAboxKNFtWiwKRN0M+jpfSzqJAQclHo001tKkjl3emc8V69igP3znzfnO/M9zcDcKT67azmjYWTwl9Vn7Vumeqzj1DVb6cleQY4oAVnIOPb+mKAGxQmKI5CWNJ2aLPatxWa3aB9K7/fB+/Z0jUF6TmMlFLQqrkECWQzOZxYGjTlOl8eeKaIY5yHnFn486xBustDjWT6dG7pmjHOJd+33t0iitTPkK6tEvjxq4h2MozQ6WFSX/LkDUGfFwfhEZj1Auz/U4pyAi5Sznd7uKzznXeVHlI/Aywmk6j7fsUsEuCGADrWARXXwjxWQsUbIupDHJI7kF5dRktg0eN81IbiZXiTESic50iwS+t1oJgL83jAiBupLDCQqwziaWSoAFSeIR3P5Xv5az00wyIn35QRYTwdSYbz8pH8fxUUAtxnFvYmEmgI0wYXUXcCCSpeEVpXlsRhBnCEATxWylL9+EKCAYhe1NGstUa6356kS9NVvt3DU2fd+Wtbm/+lSbylJqsqkSm9CRhvoJVlvKPvF1RKY/FcPn5j4UfIMLn8D4UYb54BNsilTDXKnF4CfTobA0FpoW/LSp306wkXM+XaOJhZaFkcNM82ASNAWMrhrUbRfmyeI1FvRBTpN06WKxa9BK0o2E4Pd3zfBBEwPsv9sQBnmLVbLEIZ/Xe9LYwJu/Er17W6HYVBc7vmuk0xUQ+pqxdom5Fnp55SiytXLPYoMXNM4u4SNSCFWnrVIzKG3EGyMXo6n/BQOe+bX3FClY4PwydVhthOZ9NnS+ntiLh0fxtlUJHAuGaFoVmttpVMeum0p3WEXbcll94l1wM/gZ0Ccczop77VvN2I7TlsZCsuXf1WHvWEhjO8DPtyOVg2/mvK9QqboEth+7pD6NUQC1HN/TwvydGBARi9MZSzLE4b8Ru3XhX2PBxf8E1er2A6516o0w4sIA+lwURhAON82Kwe2iDAC1Watq4XHaGQ7skLcFOtI5lDxuM2gZe6WFIotPAhbaeYlU4to5cuarF1QrcZ/lwrLaCJl66JBocYZnrNlvm2+MBCTmUymPrYZVbjdlr/BxlMjmNmNI3SAAAAAElFTkSuQmCC',
      }
    ]);
    
    console.log('Â∑≤ËÆæÁΩÆÈªòËÆ§ËæπÁ±ªÂûã‰∏∫polyline');
    
    // Ê∏≤ÊüìÁîªÂ∏É
    logicflow.render({});

    setLf(logicflow);

    // Â¶ÇÊûúÊúâprocessKeyÔºåÂä†ËΩΩÂ∑≤ÊúâÊµÅÁ®ã
    if (processKey) {
      // TODO: Âä†ËΩΩÊµÅÁ®ãÊï∞ÊçÆ
    }

    return () => {
      logicflow.destroy();
    };
  }, [processKey]);

  // Â∑•ÂÖ∑Ê†èÊìç‰Ωú
  const handleUndo = () => lf?.undo();
  const handleRedo = () => lf?.redo();
  const handleZoomIn = () => lf?.zoom(true);
  const handleZoomOut = () => lf?.zoom(false);
  const handleResetZoom = () => lf?.resetZoom();

  // ‰øùÂ≠òÊµÅÁ®ã
  const handleSave = () => {
    if (!lf) return;
    
    // Ëé∑ÂèñÊµÅÁ®ãÊï∞ÊçÆ
    const data = lf.getGraphData();
    
    // È™åËØÅÊµÅÁ®ã
    const errors = validateProcess(data);
    if (errors.length > 0) {
      message.error(errors.join('\n'));
      return;
    }

    // ‰øùÂ≠òÊµÅÁ®ã
    onSave?.(data);
    message.success('‰øùÂ≠òÊàêÂäü');
  };

  // È™åËØÅÊµÅÁ®ã
  const validateProcess = (data: any) => {
    const errors: string[] = [];
    const nodes = data.nodes || [];
    const edges = data.edges || [];

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂºÄÂßãËäÇÁÇπ
    const startNodes = nodes.filter((node: any) => node.type === 'circle' && node.text.value === 'ÂºÄÂßã');
    if (startNodes.length === 0) {
      errors.push('ÊµÅÁ®ãÂøÖÈ°ªÂåÖÂê´‰∏Ä‰∏™ÂºÄÂßãËäÇÁÇπ');
    } else if (startNodes.length > 1) {
      errors.push('ÊµÅÁ®ãÂè™ËÉΩÂåÖÂê´‰∏Ä‰∏™ÂºÄÂßãËäÇÁÇπ');
    }

    // Ê£ÄÊü•ÊòØÂê¶ÊúâÁªìÊùüËäÇÁÇπ
    const endNodes = nodes.filter((node: any) => node.type === 'circle' && node.text.value === 'ÁªìÊùü');
    if (endNodes.length === 0) {
      errors.push('ÊµÅÁ®ãÂøÖÈ°ªÂåÖÂê´‰∏Ä‰∏™ÁªìÊùüËäÇÁÇπ');
    }

    // Ê£ÄÊü•ËäÇÁÇπËøûÊé•
    nodes.forEach((node: any) => {
      const outEdges = edges.filter((edge: any) => edge.sourceNodeId === node.id);
      const inEdges = edges.filter((edge: any) => edge.targetNodeId === node.id);

      // ÂºÄÂßãËäÇÁÇπÂøÖÈ°ªÊúâÂá∫Ëæπ
      if (node.type === 'circle' && node.text.value === 'ÂºÄÂßã' && outEdges.length === 0) {
        errors.push('ÂºÄÂßãËäÇÁÇπÂøÖÈ°ªÊúâÂá∫Ëæπ');
      }

      // ÁªìÊùüËäÇÁÇπÂøÖÈ°ªÊúâÂÖ•Ëæπ
      if (node.type === 'circle' && node.text.value === 'ÁªìÊùü' && inEdges.length === 0) {
        errors.push('ÁªìÊùüËäÇÁÇπÂøÖÈ°ªÊúâÂÖ•Ëæπ');
      }

      // Êù°‰ª∂ËäÇÁÇπÂøÖÈ°ªÊúâÂ§ö‰∏™Âá∫Ëæπ
      if (node.type === 'diamond' && outEdges.length < 2) {
        errors.push('Êù°‰ª∂ËäÇÁÇπÂøÖÈ°ªÊúâÂ§ö‰∏™Âá∫Ëæπ');
      }

      // ÂÖ∂‰ªñËäÇÁÇπÂøÖÈ°ªÊúâÂÖ•ËæπÂíåÂá∫Ëæπ
      if (node.type !== 'circle' && (inEdges.length === 0 || outEdges.length === 0)) {
        errors.push(`ËäÇÁÇπ ${node.text.value || node.id} ÂøÖÈ°ªÊúâÂÖ•ËæπÂíåÂá∫Ëæπ`);
      }
    });

    return errors;
  };

  // ÂØºÂÖ•ÊµÅÁ®ã
  const handleImport = () => {
    Modal.confirm({
      title: 'ÂØºÂÖ•ÊµÅÁ®ã',
      content: 'Á°ÆÂÆöË¶ÅÂØºÂÖ•Êñ∞ÁöÑÊµÅÁ®ãÊï∞ÊçÆÂêóÔºüËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÁîªÂ∏ÉÁöÑÂÜÖÂÆπ„ÄÇ',
      onOk: () => {
        // TODO: ÂÆûÁé∞ÂØºÂÖ•ÂäüËÉΩ
        message.success('ÂØºÂÖ•ÊàêÂäü');
      },
    });
  };

  // ÂØºÂá∫ÊµÅÁ®ã
  const handleExport = () => {
    if (!lf) return;
    const data = lf.getGraphData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `process-${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
    message.success('ÂØºÂá∫ÊàêÂäü');
  };

  // Êõ¥Êñ∞ËäÇÁÇπÂ±ûÊÄß
  const handleUpdateNode = (values: any) => {
    if (!lf || !currentNode) return;
    lf.setProperties(currentNode.id, values);
    setNodeModalVisible(false);
    nodeForm.resetFields();
  };

  // ÂºÄÂßãÊ®°ÊãüËøêË°å
  const handleStartSimulation = () => {
    if (!lf) return;
    const data = lf.getGraphData() as GraphData;
    
    // Êü•ÊâæÂºÄÂßãËäÇÁÇπ
    const startNode = data.nodes.find(node => node.type === 'circle' && node.text.value === 'ÂºÄÂßã');
    if (!startNode) {
      message.error('ÊµÅÁ®ã‰∏≠ÂøÖÈ°ªÂåÖÂê´ÂºÄÂßãËäÇÁÇπ');
      return;
    }

    // ÂàùÂßãÂåñÊ®°ÊãüË∑ØÂæÑ
    setSimulationPath([{
      node: startNode,
      status: 'process',
      title: 'ÂºÄÂßãËäÇÁÇπ',
      description: 'ÊµÅÁ®ãÂºÄÂßã'
    }]);
    setCurrentStep(0);
    setSimulationVisible(true);
  };

  // Â§ÑÁêÜËäÇÁÇπÈÄâÊã©
  const handleNodeSelect = (nodeId: string) => {
    if (!lf) return;
    const data = lf.getGraphData() as GraphData;
    
    // Ëé∑ÂèñÂΩìÂâçËäÇÁÇπÁöÑÂá∫Ëæπ
    const edges = data.edges.filter(edge => edge.sourceNodeId === nodeId);
    const currentNode = data.nodes.find(node => node.id === nodeId);
    
    if (!currentNode) return;
    
    // Â¶ÇÊûúÊòØÁªìÊùüËäÇÁÇπÔºåÂÆåÊàêÊ®°Êãü
    if (currentNode.type === 'circle' && currentNode.text.value === 'ÁªìÊùü') {
      setSimulationPath(prev => [
        ...prev,
        {
          node: currentNode,
          status: 'finish',
          title: 'ÁªìÊùüËäÇÁÇπ',
          description: 'ÊµÅÁ®ãÁªìÊùü'
        }
      ]);
      message.success('ÊµÅÁ®ãÊ®°ÊãüÂÆåÊàê');
      return;
    }
    
    // Â¶ÇÊûúÊòØÊù°‰ª∂ËäÇÁÇπÔºåÊòæÁ§∫Êù°‰ª∂ÈÄâÊã©
    if (currentNode.type === 'diamond') {
      Modal.confirm({
        title: 'Êù°‰ª∂Âà§Êñ≠',
        content: (
          <Select
            style={{ width: '100%' }}
            onChange={(value) => {
              const nextNode = data.nodes.find(node => node.id === value);
              if (nextNode) {
                setSimulationPath(prev => [
                  ...prev,
                  {
                    node: nextNode,
                    status: 'process',
                    title: nextNode.properties?.name || nextNode.text.value || nextNode.type,
                    description: `ÊâßË°å${nextNode.type === 'diamond' ? 'Êù°‰ª∂Âà§Êñ≠' : 'ËäÇÁÇπ‰ªªÂä°'}`
                  }
                ]);
                setCurrentStep(prev => prev + 1);
              }
            }}
          >
            {edges.map(edge => {
              const targetNode = data.nodes.find(node => node.id === edge.targetNodeId);
              return (
                <Select.Option key={targetNode?.id} value={targetNode?.id}>
                  {targetNode?.properties?.name || targetNode?.text.value || targetNode?.type}
                </Select.Option>
              );
            })}
          </Select>
        ),
      });
    } else if (edges.length === 1) {
      // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Âá∫ËæπÔºåÁõ¥Êé•ËøõÂÖ•‰∏ã‰∏ÄËäÇÁÇπ
      const nextNode = data.nodes.find(node => node.id === edges[0].targetNodeId);
      if (nextNode) {
        setSimulationPath(prev => [
          ...prev,
          {
            node: nextNode,
            status: 'process',
            title: nextNode.properties?.name || nextNode.text.value || nextNode.type,
            description: `ÊâßË°å${nextNode.type === 'diamond' ? 'Êù°‰ª∂Âà§Êñ≠' : 'ËäÇÁÇπ‰ªªÂä°'}`
          }
        ]);
        setCurrentStep(prev => prev + 1);
      }
    }
  };

  return (
    <Layout className="process-designer-container">
      <Sider width={200} theme="light">
        <div>
          <div style={{ padding: '16px', fontWeight: 'bold', fontSize: '16px' }}>ÊµÅÁ®ãËäÇÁÇπ</div>
          <div className="lf-dnd-container" style={{ padding: '0 16px 16px 16px' }}>
            {nodeTypes.map(node => (
              <div
                key={node.type}
                className="lf-dnd-item"
                data-type={node.type}
                data-text={node.label}
                data-icon={node.icon}
                draggable
                onDragStart={(e) => {
                  console.log('ÂºÄÂßãÊãñÊãΩ', node.type, node);
                  const dragData = {
                    type: node.type,
                    text: node.label,
                    icon: node.icon
                  };
                  e.dataTransfer.setData('application/json', JSON.stringify(dragData));
                  e.dataTransfer.effectAllowed = 'move';
                  e.currentTarget.setAttribute('data-dragging', 'true');
                }}
                onDragEnd={(e) => {
                  e.currentTarget.removeAttribute('data-dragging');
                }}
                onDragOver={(e) => {
                  e.preventDefault();
                  e.dataTransfer.dropEffect = 'move';
                }}
                onDrop={(e) => {
                  e.preventDefault();
                  console.log('ÊîæÁΩÆËäÇÁÇπ');
                }}
                style={{
                  padding: '8px',
                  marginBottom: '8px',
                  border: '1px solid #d9d9d9',
                  borderRadius: '4px',
                  cursor: 'move',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  userSelect: 'none',
                  backgroundColor: '#fff'
                }}
              >
                <span>{node.icon}</span>
                <span>{node.label}</span>
              </div>
            ))}
          </div>
        </div>
      </Sider>
      <Layout className='process-designer-content'>
        <Card
          bodyStyle={{ padding: '8px 16px' }}
          style={{ marginBottom: '8px' }}
          extra={
            <Space>
              <Button icon={<UndoOutlined />} onClick={handleUndo} />
              <Button icon={<RedoOutlined />} onClick={handleRedo} />
              <Button icon={<ZoomInOutlined />} onClick={handleZoomIn} />
              <Button icon={<ZoomOutOutlined />} onClick={handleZoomOut} />
              <Button icon={<OneToOneOutlined />} onClick={handleResetZoom} />
              <Button icon={<ImportOutlined />} onClick={handleImport} />
              <Button icon={<ExportOutlined />} onClick={handleExport} />
              <Button icon={<PlayCircleOutlined />} onClick={handleStartSimulation}>
                Ê®°ÊãüËøêË°å
              </Button>
              <Button type="primary" icon={<SaveOutlined />} onClick={handleSave}>
                ‰øùÂ≠ò
              </Button>
            </Space>
          }
        />
        <Content style={{ flex: 1, position: 'relative', height: 'calc(100vh - 120px)', overflow: 'hidden' }}>
          <div 
            ref={containerRef} 
            style={{ 
              width: '100%', 
              height: '100%',
              position: 'absolute',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0
            }}
          />
        </Content>
      </Layout>

      <Modal
        title="ËäÇÁÇπÈÖçÁΩÆ"
        open={nodeModalVisible}
        onOk={() => nodeForm.submit()}
        onCancel={() => setNodeModalVisible(false)}
        className="process-designer-modal"
      >
        <Form
          form={nodeForm}
          layout="vertical"
          onFinish={handleUpdateNode}
        >
          <Form.Item
            name="name"
            label="ËäÇÁÇπÂêçÁß∞"
            rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•ËäÇÁÇπÂêçÁß∞' }]}
          >
            <Input />
          </Form.Item>

          {currentNode?.type === 'approval' && (
            <>
              <Form.Item
                name="assigneeType"
                label="Â§ÑÁêÜ‰∫∫Á±ªÂûã"
                rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©Â§ÑÁêÜ‰∫∫Á±ªÂûã' }]}
              >
                <Select>
                  <Option value="role">ÊåâËßíËâ≤</Option>
                  <Option value="user">ÊåáÂÆöÁî®Êà∑</Option>
                  <Option value="department">ÊåâÈÉ®Èó®</Option>
                </Select>
              </Form.Item>

              <Form.Item
                name="assignee"
                label="Â§ÑÁêÜ‰∫∫"
                rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©Â§ÑÁêÜ‰∫∫' }]}
              >
                <Select>
                  <Option value="manager">ÈÉ®Èó®ÁªèÁêÜ</Option>
                  <Option value="hr">‰∫∫‰∫ã</Option>
                  <Option value="finance">Ë¥¢Âä°</Option>
                </Select>
              </Form.Item>

              <Form.Item
                name="timeout"
                label="Ë∂ÖÊó∂Êó∂Èó¥"
              >
                <Input type="number" addonAfter="Â∞èÊó∂" />
              </Form.Item>
            </>
          )}

          {currentNode?.type === 'condition' && (
            <>
              <Form.Item
                name="conditionType"
                label="Êù°‰ª∂Á±ªÂûã"
                rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©Êù°‰ª∂Á±ªÂûã' }]}
              >
                <Select>
                  <Option value="form">Ë°®ÂçïÂ≠óÊÆµ</Option>
                  <Option value="script">Ëá™ÂÆö‰πâËÑöÊú¨</Option>
                </Select>
              </Form.Item>

              <Form.Item
                name="condition"
                label="Êù°‰ª∂Ë°®ËææÂºè"
                rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•Êù°‰ª∂Ë°®ËææÂºè' }]}
              >
                <Input.TextArea rows={4} placeholder="ËØ∑ËæìÂÖ•Êù°‰ª∂Ë°®ËææÂºèÔºå‰æãÂ¶ÇÔºöamount > 1000" />
              </Form.Item>
            </>
          )}

          {currentNode?.type === 'parallel' && (
            <>
              <Form.Item
                name="parallelType"
                label="Âπ∂Ë°åÁ±ªÂûã"
                rules={[{ required: true, message: 'ËØ∑ÈÄâÊã©Âπ∂Ë°åÁ±ªÂûã' }]}
              >
                <Select>
                  <Option value="all">ÂÖ®ÈÉ®ÈÄöËøá</Option>
                  <Option value="any">‰ªª‰∏ÄÈÄöËøá</Option>
                  <Option value="count">ÊåáÂÆöÊï∞Èáè</Option>
                </Select>
              </Form.Item>

              {nodeForm.getFieldValue('parallelType') === 'count' && (
                <Form.Item
                  name="count"
                  label="ÈÄöËøáÊï∞Èáè"
                  rules={[{ required: true, message: 'ËØ∑ËæìÂÖ•ÈÄöËøáÊï∞Èáè' }]}
                >
                  <Input type="number" min={1} />
                </Form.Item>
              )}
            </>
          )}
        </Form>
      </Modal>

      {/* Ê®°ÊãüËøêË°åÂØπËØùÊ°Ü */}
      <Modal
        title="ÊµÅÁ®ãÊ®°ÊãüËøêË°å"
        open={simulationVisible}
        onCancel={() => setSimulationVisible(false)}
        footer={[
          <Button key="close" onClick={() => setSimulationVisible(false)}>
            ÂÖ≥Èó≠
          </Button>
        ]}
        width={600}
        className="process-designer-modal"
      >
        <Steps
          direction="vertical"
          current={currentStep}
          items={simulationPath.map((item, index) => ({
            title: item.title,
            description: item.description,
            status: item.status,
            onClick: () => handleNodeSelect(item.node.id)
          }))}
        />
      </Modal>
    </Layout>
  );
};

export default ProcessDesigner; 